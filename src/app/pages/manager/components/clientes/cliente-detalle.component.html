<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/gestor/clientes"></ion-back-button>
    </ion-buttons>
    <ion-title>Detalle del Cliente</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="refreshData()">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="bank-gradient-bg">
  <div class="bank-content-container">

    @if (isLoading()) {
    <!-- Loading State -->
    <div class="bank-loading-section">
      <div class="loading-card">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Cargando información del cliente...</p>
      </div>
    </div>
    } @else if (!hasCliente()) {
    <!-- Error State -->
    <div class="bank-empty-state">
      <div class="empty-card">
        <ion-icon name="person-outline" class="empty-icon"></ion-icon>
        <h3>Cliente no encontrado</h3>
        <p>No se pudo encontrar la información del cliente.</p>
        <ion-button fill="clear" (click)="goBack()">
          <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
          Volver a Clientes
        </ion-button>
      </div>
    </div>
    } @else {
    <!-- Cliente Info -->
    <div class="bank-section mb-xl">
      <div class="bank-glass-card client-header-card">
        <div class="client-header">
          <div class="client-avatar">
            <ion-icon name="person-circle-outline"></ion-icon>
          </div>
          <div class="client-info">
            <h2 class="client-name">{{ cliente()?.nombre }}</h2>
            <p class="client-email">{{ cliente()?.email || 'Sin email' }}</p>
            <div class="client-meta">
              <ion-chip [color]="getEstadoColor(cliente()?.estado || '')">
                {{ cliente()?.estado }}
              </ion-chip>
              <span class="client-id">ID: {{ cliente()?.id }}</span>
            </div>
          </div>
          <div class="client-actions">
            <ion-button fill="solid" color="success" (click)="createAccount()">
              <ion-icon name="add-circle-outline" slot="start"></ion-icon>
              Crear Cuenta
            </ion-button>
          </div>
        </div>

        <div class="client-stats">
          <div class="stat-item">
            <ion-icon name="card-outline"></ion-icon>
            <div>
              <span class="stat-value">{{ cliente()?.cuentasActivas || 0 }}</span>
              <span class="stat-label">Cuentas Activas</span>
            </div>
          </div>
          <div class="stat-item">
            <ion-icon name="swap-horizontal-outline"></ion-icon>
            <div>
              <span class="stat-value">{{ cliente()?.totalTransacciones || 0 }}</span>
              <span class="stat-label">Transacciones</span>
            </div>
          </div>
          <div class="stat-item">
            <ion-icon name="trending-up-outline"></ion-icon>
            <div>
              <span class="stat-value">{{ formatCurrency(cliente()?.volumenTotal || 0, 'CRC') }}</span>
              <span class="stat-label">Volumen Total</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="bank-section mb-lg">
      <ion-segment (ionChange)="setActiveTab($event.detail.value)" [value]="activeTab()">
        <ion-segment-button value="info">
          <ion-icon name="information-circle-outline"></ion-icon>
          <ion-label>Información</ion-label>
        </ion-segment-button>
        <ion-segment-button value="cuentas">
          <ion-icon name="card-outline"></ion-icon>
          <ion-label>Cuentas</ion-label>
        </ion-segment-button>
        <ion-segment-button value="transacciones">
          <ion-icon name="list-outline"></ion-icon>
          <ion-label>Transacciones</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Tab Content -->
    @switch (activeTab()) {
      @case ('info') {
        <div class="bank-section">
          <div class="bank-glass-card">
            <div class="info-section">
              <h3 class="section-title">Información Personal</h3>
              <div class="info-grid">
                <div class="info-item">
                  <ion-icon name="card-outline"></ion-icon>
                  <span class="info-label">Identificación:</span>
                  <span class="info-value">{{ cliente()?.identificacion }}</span>
                </div>
                <div class="info-item">
                  <ion-icon name="call-outline"></ion-icon>
                  <span class="info-label">Teléfono:</span>
                  <span class="info-value">{{ cliente()?.telefono || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <ion-icon name="mail-outline"></ion-icon>
                  <span class="info-label">Email:</span>
                  <span class="info-value">{{ cliente()?.email || 'No registrado' }}</span>
                </div>
                <div class="info-item">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <span class="info-label">Fecha Registro:</span>
                  <span class="info-value">{{ formatDate(cliente()?.fechaRegistro || '') }}</span>
                </div>
                @if (cliente()?.ultimaOperacion) {
                <div class="info-item">
                  <ion-icon name="time-outline"></ion-icon>
                  <span class="info-label">Última Operación:</span>
                  <span class="info-value">{{ formatDateTime(cliente()?.ultimaOperacion || '') }}</span>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
      }

      @case ('cuentas') {
        <div class="bank-section">
          @if (hasCuentas()) {
            <div class="bank-list-grid">
              @for (cuenta of cuentas(); track cuenta.id) {
              <div class="bank-glass-card account-card">
                <div class="account-header">
                  <div class="account-info">
                    <h4 class="account-number">{{ cuenta.numero }}</h4>
                    <div class="account-meta">
                      <ion-chip [color]="getEstadoColor(cuenta.estado)">{{ cuenta.estado }}</ion-chip>
                      <span class="account-type">{{ cuenta.tipo }}</span>
                    </div>
                  </div>
                  <div class="account-balance">
                    <span class="balance-amount">{{ formatCurrency(cuenta.saldo, cuenta.moneda) }}</span>
                    <span class="balance-currency">{{ cuenta.moneda }}</span>
                  </div>
                </div>
                <div class="account-details">
                  <div class="detail-item">
                    <ion-icon name="person-outline"></ion-icon>
                    <span>{{ cuenta.clienteNombre }}</span>
                  </div>
                  <div class="detail-item">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <span>Apertura: {{ formatDate(cuenta.fechaApertura) }}</span>
                  </div>
                </div>
                <div class="account-actions">
                  <ion-button fill="outline" size="small" expand="block" (click)="viewCuentaDetail(cuenta)">
                    <ion-icon name="eye-outline" slot="start"></ion-icon>
                    Ver Detalles
                  </ion-button>
                </div>
              </div>
              }
            </div>
          } @else {
            <div class="bank-empty-state">
              <div class="empty-card">
                <ion-icon name="card-outline" class="empty-icon"></ion-icon>
                <h3>Sin Cuentas</h3>
                <p>Este cliente aún no tiene cuentas registradas.</p>
                <ion-button fill="solid" color="success" (click)="createAccount()">
                  <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                  Crear Primera Cuenta
                </ion-button>
              </div>
            </div>
          }
        </div>
      }

      @case ('transacciones') {
        <div class="bank-section">
          @if (hasTransacciones()) {
            <div class="bank-list-grid">
              @for (transaccion of transacciones(); track transaccion.id) {
              <div class="bank-glass-card transaction-card">
                <div class="transaction-header">
                  <div class="transaction-info">
                    <h4 class="transaction-type">{{ transaccion.tipo }}</h4>
                    <p class="transaction-description">{{ transaccion.descripcion || 'Sin descripción' }}</p>
                  </div>
                  <div class="transaction-amount">
                    <span class="amount-value">{{ formatCurrency(transaccion.monto, transaccion.moneda) }}</span>
                    <ion-chip [color]="getTipoColor(transaccion.tipo)" size="small">{{ transaccion.estado }}</ion-chip>
                  </div>
                </div>
                <div class="transaction-details">
                  <div class="detail-item">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <span>{{ formatDateTime(transaccion.fecha) }}</span>
                  </div>
                  @if (transaccion.fechaEjecucion) {
                  <div class="detail-item">
                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                    <span>Ejecución: {{ formatDateTime(transaccion.fechaEjecucion) }}</span>
                  </div>
                  }
                  @if (transaccion.comprobanteReferencia) {
                  <div class="detail-item">
                    <ion-icon name="receipt-outline"></ion-icon>
                    <span>Referencia: {{ transaccion.comprobanteReferencia }}</span>
                  </div>
                  }
                </div>
              </div>
              }
            </div>

            <!-- View All Button -->
            <div class="view-all-container">
              <ion-button fill="outline" expand="block" (click)="viewAllTransactions()">
                <ion-icon name="list-outline" slot="start"></ion-icon>
                Ver Todas las Transacciones
              </ion-button>
            </div>
          } @else {
            <div class="bank-empty-state">
              <div class="empty-card">
                <ion-icon name="list-outline" class="empty-icon"></ion-icon>
                <h3>Sin Transacciones</h3>
                <p>No hay transacciones recientes para este cliente.</p>
              </div>
            </div>
          }
        </div>
      }
    }

    }

  </div>
</ion-content>