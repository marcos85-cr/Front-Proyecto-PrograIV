<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Crear Nueva Cuenta</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="bank-gradient-bg">
  <div class="bank-content-container">

    @if (isLoading()) {
      <div class="loading-container">
        <ion-spinner name="crescent" color="light"></ion-spinner>
        <p>Cargando información...</p>
      </div>
    } @else if (!hasCliente()) {
      <div class="empty-state">
        <div class="empty-icon">
          <ion-icon name="person-outline"></ion-icon>
        </div>
        <h3>Cliente no encontrado</h3>
        <p>No se pudo cargar la información del cliente.</p>
        <ion-button fill="outline" (click)="goBack()">
          <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
          Volver
        </ion-button>
      </div>
    } @else {

      <!-- Header del Cliente -->
      <div class="bank-section">
        <div class="client-header-card">
          <div class="client-avatar">
            <img [src]="'https://ui-avatars.com/api/?name=' + cliente()!.nombre + '&background=random&size=80'" [alt]="cliente()!.nombre">
          </div>
          <div class="client-info">
            <h3>{{ cliente()?.nombre }}</h3>
            <span class="client-id">{{ cliente()?.identificacion }}</span>
            <div class="client-stats">
              <ion-badge color="primary">{{ cliente()?.cuentasActivas || 0 }} cuentas</ion-badge>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario -->
      <div class="bank-section">
        <div class="bank-section-header">
          <h3>Información de la Cuenta</h3>
        </div>

        <form [formGroup]="cuentaForm" (ngSubmit)="validateAndSubmit()">

          <!-- Tipo de Cuenta -->
          <div class="bank-form-group">
            <ion-item class="bank-input-item" [class.invalid]="hasError('tipo', 'required')">
              <ion-label position="floating">Tipo de Cuenta</ion-label>
              <ion-select formControlName="tipo" placeholder="Seleccionar tipo">
                @for (type of accountTypes; track type.value) {
                  <ion-select-option [value]="type.value">{{ type.label }}</ion-select-option>
                }
              </ion-select>
            </ion-item>
            @if (hasError('tipo', 'required') && cuentaForm.get('tipo')?.touched) {
              <div class="bank-form-error">
                <ion-icon name="alert-circle-outline"></ion-icon>
                {{ getErrorMessage('tipo') }}
              </div>
            }
          </div>

          <!-- Moneda -->
          <div class="bank-form-group">
            <ion-item class="bank-input-item" [class.invalid]="hasError('moneda', 'required')">
              <ion-label position="floating">Moneda</ion-label>
              <ion-select formControlName="moneda" placeholder="Seleccionar moneda">
                @for (currency of currencies; track currency.value) {
                  <ion-select-option [value]="currency.value">{{ currency.label }}</ion-select-option>
                }
              </ion-select>
            </ion-item>
            @if (hasError('moneda', 'required') && cuentaForm.get('moneda')?.touched) {
              <div class="bank-form-error">
                <ion-icon name="alert-circle-outline"></ion-icon>
                {{ getErrorMessage('moneda') }}
              </div>
            }
          </div>

          <!-- Saldo Inicial -->
          <div class="bank-form-group">
            <ion-item class="bank-input-item" [class.invalid]="hasError('saldoInicial', 'required') || hasError('saldoInicial', 'min')">
              <ion-label position="floating">Saldo Inicial</ion-label>
              <ion-input type="number" formControlName="saldoInicial" placeholder="0.00" min="0"></ion-input>
            </ion-item>
            @if ((hasError('saldoInicial', 'required') || hasError('saldoInicial', 'min')) && cuentaForm.get('saldoInicial')?.touched) {
              <div class="bank-form-error">
                <ion-icon name="alert-circle-outline"></ion-icon>
                {{ getErrorMessage('saldoInicial') }}
              </div>
            }
          </div>

          <!-- Límite de Cuentas -->
          @let formValue = cuentaForm.value;
          @if (formValue.tipo && formValue.moneda) {
            @let count = getCuentasMismoTipo(formValue.tipo, formValue.moneda);
            <div class="limit-info" [class.warning]="count === 2" [class.error]="count >= 3">
              <ion-icon [name]="count >= 3 ? 'alert-circle' : count === 2 ? 'warning' : 'information-circle'"></ion-icon>
              <span>
                {{ formValue.tipo }} en {{ formValue.moneda }}: <strong>{{ count }}/3</strong>
                @if (count >= 3) {
                  — Límite alcanzado
                } @else if (count === 2) {
                  — Solo 1 más permitida
                }
              </span>
            </div>
          }

          <!-- Cuentas Existentes -->
          @if (cuentasExistentes().length > 0) {
            <div class="existing-accounts-section">
              <div class="section-label">
                <ion-icon name="wallet-outline"></ion-icon>
                <span>Cuentas existentes ({{ cuentasExistentes().length }})</span>
              </div>
              <div class="accounts-list">
                @for (cuenta of cuentasExistentes(); track cuenta.id) {
                  <div class="account-item">
                    <div class="account-main">
                      <span class="account-type">{{ cuenta.tipo }}</span>
                      <span class="account-currency">{{ cuenta.moneda }}</span>
                    </div>
                    <div class="account-secondary">
                      <span class="account-balance">{{ formatCurrency(cuenta.saldo, cuenta.moneda) }}</span>
                      <ion-badge [color]="getEstadoColor(cuenta.estado)" size="small">{{ cuenta.estado }}</ion-badge>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Botones -->
          <div class="bank-section">
            <div class="bank-button-group">
              <ion-button type="button" fill="outline" color="medium" (click)="goBack()" expand="block">
                <ion-icon name="close-outline" slot="start"></ion-icon>
                Cancelar
              </ion-button>
              <ion-button
                type="submit"
                color="primary"
                [disabled]="cuentaForm.invalid || isLoading() || !puedeCrearMasCuentas(cuentaForm.value.tipo, cuentaForm.value.moneda)"
                expand="block">
                @if (isLoading()) {
                  <ion-spinner name="crescent" slot="start"></ion-spinner>
                  Creando...
                } @else {
                  <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                  Crear Cuenta
                }
              </ion-button>
            </div>
          </div>
        </form>
      </div>

    }

  </div>
</ion-content>
